rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }

    function currentUid() {
      return request.auth.uid;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return isSignedIn() &&
        (userDoc(currentUid()).data.role == 'admin' ||
         userDoc(currentUid()).data.role == 'super_admin');
    }

    // PHONE NUMBERS collection for uniqueness checking
    match /phoneNumbers/{phoneNumber} {
      allow read: if true; // Allow anyone to check phone number availability
      allow create: if isSignedIn() && phoneNumber == request.resource.data.phoneNumber;
      allow update: if isSignedIn() && phoneNumber == request.resource.data.phoneNumber;
      allow delete: if isSignedIn() && phoneNumber == resource.data.phoneNumber;
    }

    // USERNAME availability checking
    match /usernames/{username} {
      allow read: if true; // Allow anyone to check username availability
      allow create: if isSignedIn() && username == request.resource.data.username;
      allow update: if isSignedIn() && username == request.resource.data.username;
      allow delete: if isSignedIn() && username == resource.data.username;
    }

    // USERS
    match /users/{uid} {
      allow create: if isSignedIn()
        && uid == currentUid()
        && request.resource.data.role == 'user';

      // Allow reading user data for trust badges and public profile info
      allow read: if isAdmin() || 
        (isSignedIn() && uid == currentUid()) ||
        (isSignedIn() && request.auth != null); // Allow any signed-in user to read for trust badges

      allow update: if isSignedIn() && uid == currentUid()
        && !request.resource.data.diff(resource.data)
            .changedKeys()
            .hasAny(['role','totalAdsPosted','activeAdsCount','rejectedAdsCount','updatedBy','createdAt'])
        || isAdmin();

      allow delete: if isAdmin();
    }

    // ADS - SIMPLIFIED RULES
    match /ads/{adId} {
      // Anyone can create their own ad (if signed in)
      // Allow 'pending' status for manual review OR 'active' status for verified ads
      allow create: if isSignedIn()
        && request.resource.data.userId == currentUid()
        && (
          request.resource.data.status == 'pending' ||
          (
            request.resource.data.status == 'active' &&
            request.resource.data.isVerified == true &&
            request.resource.data.verifiedAt is timestamp &&
            request.resource.data.vehicleVerification is map
          )
        );

      // SIMPLIFIED: Allow reading ALL ads for everyone (your app filters in memory)
      allow read: if true;

      // Updates: owners can edit their own ads with controlled status transitions; admins can do anything.
      allow update: if isSignedIn() && (
        (
          resource.data.userId == currentUid() && (
            // SOLD: only status and previousStatus (optional clear)
            (
              request.resource.data.status == 'sold' &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','previousStatus']) &&
              (!('previousStatus' in request.resource.data) || request.resource.data.previousStatus == null)
            ) ||
            // REMOVED: may set previousStatus (string)
            (
              request.resource.data.status == 'removed' &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','previousStatus']) &&
              (request.resource.data.previousStatus is string)
            ) ||
            // REACTIVATE from removed: restore status to active/pending and clear previousStatus
            (
              resource.data.status == 'removed' &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','previousStatus']) &&
              request.resource.data.status in ['active','pending'] &&
              request.resource.data.previousStatus == null
            ) ||
            // Other updates: cannot touch status, previousStatus, moderation fields
            (
              !request.resource.data.diff(resource.data)
                .changedKeys()
                .hasAny(['status','previousStatus','approvedAt','approvedBy','rejectedAt','rejectedBy','rejectionReason'])
            )
          )
        ) || isAdmin()
      );

      // Deletes: owners can delete their own ads; admins can delete any ad
      allow delete: if isSignedIn() && (
        resource.data.userId == currentUid() || isAdmin()
      );
    }

    // REVIEWS collection (separate collection)
    match /reviews/{reviewId} {
      // Allow reading all reviews
      allow read: if true;

      // Allow creating reviews only if:
      allow create: if isSignedIn()
        && request.resource.data.userId == currentUid()
        && request.resource.data.adId is string
        && request.resource.data.adTitle is string
        && request.resource.data.adOwnerId is string
        && request.resource.data.userName is string
        && request.resource.data.comment is string
        && request.resource.data.rating is int
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && request.resource.data.createdAt is timestamp
        && request.resource.data.adOwnerId != currentUid();

      // Allow users to update their own reviews (only comment and rating)
      allow update: if isSignedIn() 
        && resource.data.userId == currentUid()
        && request.resource.data.userId == currentUid()
        && request.resource.data.adId == resource.data.adId
        && request.resource.data.adTitle == resource.data.adTitle
        && request.resource.data.adOwnerId == resource.data.adOwnerId
        && request.resource.data.userName == resource.data.userName
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.comment is string
        && request.resource.data.rating is int
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5;

      // Allow users to delete their own reviews
      allow delete: if isSignedIn() && resource.data.userId == currentUid();

      // Admins can do anything with reviews
      allow write: if isAdmin();
    }

    // ACTIVITIES (audit log)
    match /activities/{activityId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdmin();
    }

    // BLOG POSTS collection
    match /blog_posts/{postId} {
      // Anyone can read blog posts (app filters by isPublished)
      allow read: if true;
      
      // Only admins can create, update, or delete blog posts
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // VIDEOS collection
    match /videos/{videoId} {
      // Anyone can read videos (app filters by isPublished)
      allow read: if true;
      
      // Only admins can create, update, or delete videos
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // BLOGS collection (new addition for our implementation)
    match /blogs/{blogId} {
      // Allow admins to create, read, update, and delete blogs
      allow create, read, update, delete: if isAdmin();
    }

    // CONVERSATIONS collection for chat
    match /conversations/{conversationId} {
      // Helper function to check if user is a participant
      function isParticipant() {
        return isSignedIn() && (
          (resource != null && resource.data.participant1Id == currentUid()) ||
          (resource != null && resource.data.participant2Id == currentUid())
        );
      }

      // Helper function to check if user will be a participant (for create)
      function willBeParticipant() {
        return isSignedIn() && (
          request.resource.data.participant1Id == currentUid() ||
          request.resource.data.participant2Id == currentUid()
        );
      }

      // Users can read conversations they are part of
      // Also allow read if document doesn't exist (for existence check before creation)
      allow read: if isSignedIn() && (
        (resource != null && (
          resource.data.participant1Id == currentUid() ||
          resource.data.participant2Id == currentUid()
        )) ||
        !exists(/databases/$(database)/documents/conversations/$(conversationId))
      );

      // Users can create conversations they are part of
      allow create: if willBeParticipant();

      // Users can update conversations they are part of (for last message, unread counts)
      allow update: if isParticipant();

      // Messages subcollection
      match /messages/{messageId} {
        // Helper function to get conversation data safely
        function getConversationData() {
          return get(/databases/$(database)/documents/conversations/$(conversationId)).data;
        }

        // Helper function to check if user is participant in parent conversation
        function isConversationParticipant() {
          return isSignedIn() && (
            getConversationData().participant1Id == currentUid() ||
            getConversationData().participant2Id == currentUid()
          );
        }

        // Users can read messages in conversations they are part of
        allow read: if isConversationParticipant();

        // Users can create messages where they are the sender
        allow create: if isSignedIn() && 
          request.resource.data.senderId == currentUid() &&
          isConversationParticipant();

        // Users can update messages:
        // 1. If they are the sender (to mark as delivered)
        // 2. If they are the receiver (to mark as read)
        allow update: if isSignedIn() && isConversationParticipant() && (
          // Sender can update their own messages (to mark as delivered)
          (resource.data.senderId == currentUid() && 
           request.resource.data.diff(resource.data).changedKeys().hasOnly(['status'])) ||
          // Receiver can update messages they received (to mark as read)
          (resource.data.receiverId == currentUid() && 
           (request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'isRead']) ||
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['isRead'])))
        );

        // Users can delete messages in conversations they are part of
        // This allows deletion for all users (not just sender)
        allow delete: if isSignedIn() && isConversationParticipant();
      }
    }

    // Deny everything else - KEEP THIS AT THE END
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
